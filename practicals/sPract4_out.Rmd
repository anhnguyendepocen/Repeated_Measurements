## Practical 4: Mixed Effects Models for Discrete Data
We start by loading the packages we will need for this practical and the data from 
[GitHub](https://github.com/drizopoulos/Repeated_Measurements). This is achieved with the
following commands:
```{r}
# packages
library("lattice")
library("lme4")
library("MASS")
library("splines")

# data
con <- url("https://raw.github.com/drizopoulos/Repeated_Measurements/master/Data.RData")
load(con)
close(con)
```
```{r, echo = FALSE}
options(warn = (-1))
```

### Question 1
The following piece of code creates the dummy variable for abnormal prothrombin time:
```{r}
pbc2$Dicht_prothro <- as.numeric(with(pbc2, prothrombin < 11 | prothrombin > 13))
```

### Question 2
To examine graphically the shape of the probability of abnormal prothrombin time we can
smooth the scatterplot of the `Dicht_prothro`. Using function 
[xyplot()](https://goo.gl/cGSjZk) as in previous practicals, ***
```{r}
ind <- with(pbc2, ave(Dicht_prothro, id, FUN = length)) >= 5
```


```{r}
xyplot(Dicht_prothro ~ year | id, data = pbc2, subset = ind,
       type = c("p", "spline"), lwd = 2,
       xlab = "Time (years)", ylab = "Abnormal Prothrombin Time",
       layout = c(6, 6), as.table = TRUE,
       scales = list(y = list(at = 0:1, labels = c("No", "Yes"))))
```


### Question 3

```{r}
fm_1 <- glmer(Dicht_prothro ~ ns(year, 2) * sex + drug + drug:sex + (1 | id), 
              data = pbc2, family = binomial(), nAGQ = 15)

summary(fm_1)
```

### Question 4

```{r}
fm_2 <- glmer(Dicht_prothro ~ year * sex + drug + drug:sex + (year | id), 
              data = pbc2, family = binomial(), nAGQ = 1)

anova(fm_1, fm_2)
```

```{r}
summary(fm_2)
```

### Question 5

```{r}
fm_3 <- glmer(Dicht_prothro ~ year + sex + drug + (year | id), 
              data = pbc2, family = binomial(), nAGQ = 1)

anova(fm_3, fm_2)
```

### Question 6

```{r}
summary(fm_3)
```

### Question 7

```{r}
effectPlotData_lmer <- function (object, newdata, orig_data, 
                                 type = c("lp", "response"), M = 100) {
    type <- match.arg(type)
    form <- formula(object)
    namesVars <- all.vars(form)
    fam <- family(object)
    orig_data <- orig_data[complete.cases(orig_data[namesVars]), ]
    TermsX <- delete.response(terms(object, fixed.only = TRUE))
    mfX <- model.frame(TermsX, data = orig_data)
    TermsX_new <- attr(mfX, "terms")
    betas <- fixef(object)
    V <- vcov(object)
    if (type == "lp" || (fam$family == "gaussian" && fam$link == "indentity")) {
        mfX_new <- model.frame(TermsX_new, newdata, xlev = .getXlevels(TermsX, mfX))
        X <- model.matrix(TermsX_new, mfX_new)
        eta <- c(X %*% betas)
        ses <- sqrt(diag(X %*% V %*% t(X)))
        newdata$pred <- eta
        newdata$low <- eta - 1.96 * ses
        newdata$upp <- eta + 1.96 * ses
        newdata
    } else {
        idVar <- names(object@flist)
        if (length(idVar) > 1)
            stop("The current version of this function only works for ",
                 "a single grouping factor.")
        ind <- rep(1:nrow(newdata), each = M)
        newdata2 <- newdata[ind, ]
        newdata2[[idVar]] <- factor(1:nrow(newdata2))
        mfX_new <- model.frame(TermsX_new, newdata2, xlev = .getXlevels(TermsX, mfX))
        X <- model.matrix(TermsX_new, mfX_new)
        formRE <- as.character(formula(object, random.only = TRUE))
        formRE <- as.formula(paste(formRE[c(1, 3)]))
        newRE <- lme4:::mkNewReTrms(object, newdata2, re.form = formRE,
                                    allow.new.levels = TRUE)
        D <- VarCorr(object)[[1]]
        b <- c(t(mvrnorm(nrow(newdata2), rep(0, NROW(D)), D)))
        eta0 <- c(X %*% betas)
        eta <- c(X %*% betas) + colSums(newRE$Zt * b)
        newdata$pred0 <- tapply(fam$linkinv(eta0), ind, mean)
        newdata$pred <- tapply(fam$linkinv(eta), ind, mean)
        newdata
    }
}
```

```{r}
newDF <- with(pbc2, expand.grid(
    year = seq(0, 12, length.out = 15),
    drug = levels(drug),
    sex = levels(sex)
))
```

```{r}
xyplot(pred + low + upp ~ year | sex * drug, 
       data = effectPlotData_lmer(fm_3, newDF, orig_data = pbc2), 
       type = "l", lty = c(1, 2, 2), col = c(2, 1, 1), lwd = 2)
```


### Question 8

```{r}
key <- simpleKey(c("marginal probabilities", "median patient"), points = FALSE, lines = TRUE)
key$lines$col <- c("red", "blue")
key$lines$lwd <- c(2, 2)
```

```{r}
xyplot(pred + pred0 ~ year | sex * drug, 
       data = effectPlotData_lmer(fm_3, newDF, orig_data = pbc2, 
                                  type = "response", M = 3000), 
       type = "l", lty = 1, lwd = 2, col = c("red", "blue"), key = key)
```
